<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>UNIVERSITY WAR: BINGO PRO v4.0</title>
    <style>
        :root { --bg: #0a0c14; --panel: #161b2a; --red: #ff4d4d; --yellow: #ffd700; --blue: #4d79ff; }
        body { background: var(--bg); color: #fff; font-family: 'Pretendard', sans-serif; margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        .screen { display: none; width: 100%; max-width: 450px; padding: 20px; text-align: center; box-sizing: border-box; }
        .active { display: block; }

        /* 매칭 중 화면 스타일 */
        #matching-status { font-size: 1.2rem; color: #4d79ff; margin: 20px 0; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        /* 스코어보드 (3판 2선승) */
        .scoreboard { display: flex; justify-content: space-around; background: #1a1c2c; padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #333; }
        .score-dot { width: 15px; height: 15px; border-radius: 50%; background: #333; margin: 0 3px; display: inline-block; }
        .score-dot.win { background: #00c853; box-shadow: 0 0 8px #00c853; }

        /* 보드 및 말 디자인: 흰색 테두리 제거 및 뒷면색 테두리 적용 */
        .board { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; background: #222639; padding: 12px; border-radius: 12px; margin: 15px 0; }
        .cell { aspect-ratio: 1/1; background: #1a1c2c; border: 1px solid #3f445e; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; position: relative; }
        .cell.last-act { outline: 4px solid #ffffff; outline-offset: 2px; }

        .piece { 
            width: 80%; height: 80%; border-radius: 6px; box-sizing: border-box; 
            border-width: 7px; border-style: solid; transition: all 0.2s;
        }
        .bg-red { background-color: var(--red); } .bd-red { border-color: var(--red); }
        .bg-yellow { background-color: var(--yellow); } .bd-yellow { border-color: var(--yellow); }
        .bg-blue { background-color: var(--blue); } .bd-blue { border-color: var(--blue); }

        /* 인벤토리 선택 강조 (글로우) */
        .inv-item { cursor: pointer; padding: 8px; border-radius: 8px; opacity: 0.4; }
        .inv-item.selected { opacity: 1; box-shadow: 0 0 15px rgba(255, 255, 255, 0.4); background: rgba(255,255,255,0.1); }
        .inv-preview { width: 45px; height: 45px; border-radius: 6px; border-width: 6px; border-style: solid; margin: 0 auto 5px; }

        button { background: #2d334d; color: white; border: 1px solid #444; padding: 12px; border-radius: 8px; cursor: pointer; width: 100%; margin: 5px 0; font-weight: bold; }
        .primary { background: #4d79ff; border: none; }
    </style>
</head>
<body>

    <div id="screen-lobby" class="screen active">
        <h1>UNIVERSITY WAR</h1>
        <p>양면빙고 (3판 2선승제)</p>
        <div id="lobby-ui">
            <input type="text" id="nick-in" placeholder="닉네임" style="width:100%; padding:12px; margin-bottom:10px; background:#111; border:1px solid #444; color:#fff; border-radius:8px;">
            <input type="text" id="room-in" placeholder="방 코드 (예: WAR1)" style="width:100%; padding:12px; margin-bottom:10px; background:#111; border:1px solid #444; color:#fff; border-radius:8px;">
            <button class="primary" onclick="initGame()">방 입장 및 매칭 시작</button>
        </div>
        <div id="matching-ui" style="display:none;">
            <div id="matching-status">상대방을 기다리는 중...</div>
            <p id="room-code-display"></p>
            <button onclick="location.reload()">취소하기</button>
        </div>
    </div>

    <div id="screen-game" class="screen">
        <div class="scoreboard">
            <div>
                <span id="p1-name">P1</span><br>
                <div id="p1-score-dots"></div>
            </div>
            <div style="font-size: 1.5rem; font-weight: bold;">VS</div>
            <div>
                <span id="p2-name">P2</span><br>
                <div id="p2-score-dots"></div>
            </div>
        </div>

        <div id="status-bar" style="background:var(--panel); padding:10px; border-radius:10px;">
            <div id="turn-txt" style="font-weight:bold; color:#4d79ff;">차례 대기 중...</div>
            <div id="target-txt">목표 색상: <span id="my-target" style="font-weight:bold;">-</span></div>
        </div>

        <div class="board" id="board"></div>

        <div id="phase2-ui" style="display:none; flex-direction:row; gap:5px; margin-bottom:10px;">
            <button onclick="setAct('place')" id="act-p" style="background:#00c853;">착수</button>
            <button onclick="setAct('move')" id="act-m">이동</button>
            <button onclick="setAct('flip')" id="act-f">뒤집기</button>
        </div>

        <div class="inventory" id="inv-ui" style="display:flex; justify-content:space-around;"></div>
        <button style="background:#444; font-size:0.8rem; margin-top:10px;" onclick="flipSelected()">말 뒤집기 (앞면 색상 교체)</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDcKWKTei9L2Sat-XxinlXknabIcHgmjGs",
            authDomain: "d454545-ac9b1.firebaseapp.com",
            projectId: "d454545-ac9b1",
            storageBucket: "d454545-ac9b1.firebasestorage.app",
            messagingSenderId: "438189498590",
            appId: "1:438189498590:web:5c515415a9aa1f2b5aa24f"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let g = {
            room: '', nick: '', role: '', target: '', 
            turn: 1, lastIdx: -1, board: Array(16).fill(null),
            inv: [ { sides: ['red', 'yellow'], count: 3, top: 0 }, { sides: ['yellow', 'blue'], count: 3, top: 0 }, { sides: ['blue', 'red'], count: 3, top: 0 } ],
            selIdx: 0, act: 'place', mFrom: null, scores: { host: 0, guest: 0 }
        };

        window.initGame = async () => {
            g.nick = document.getElementById('nick-in').value || 'Guest';
            g.room = document.getElementById('room-in').value.toUpperCase();
            if(!g.room) return alert("방 코드를 입력하세요.");

            const ref = doc(db, "match_v1", g.room);
            const snap = await getDoc(ref);
            const colors = ['red', 'yellow', 'blue'].sort(() => Math.random() - 0.5);

            if(!snap.exists()) {
                g.role = 'host';
                await setDoc(ref, { 
                    status: 'waiting', board: Array(16).fill(null), turn: 1, lastIdx: -1,
                    host: { nick: g.nick, target: colors[0], inv: g.inv, score: 0 },
                    guest: null, pool: [colors[1], colors[2]]
                });
                showMatchingUI();
            } else {
                const data = snap.data();
                if(!data.guest) {
                    g.role = 'guest';
                    await updateDoc(ref, { 
                        status: 'playing',
                        guest: { nick: g.nick, target: data.pool[0], inv: g.inv, score: 0 }
                    });
                } else { return alert("방이 가득 찼습니다."); }
            }
            startListening(ref);
        };

        function showMatchingUI() {
            document.getElementById('lobby-ui').style.display = 'none';
            document.getElementById('matching-ui').style.display = 'block';
            document.getElementById('room-code-display').innerText = `방 코드: ${g.room}`;
        }

        function startListening(ref) {
            onSnapshot(ref, (s) => {
                const data = s.data(); if(!data) return;
                if(data.status === 'playing') {
                    document.getElementById('screen-lobby').classList.remove('active');
                    document.getElementById('screen-game').classList.add('active');
                    g.board = data.board; g.turn = data.turn; g.lastIdx = data.lastIdx;
                    g.scores = { host: data.host.score, guest: data.guest.score };
                    const me = g.role === 'host' ? data.host : data.guest;
                    const opp = g.role === 'host' ? data.guest : data.host;
                    g.target = me.target; g.inv = me.inv;
                    updateUI(me, opp);
                }
            });
        }

        function updateUI(me, opp) {
            renderBoard();
            renderInv();
            document.getElementById('my-target').innerText = g.target.toUpperCase();
            document.getElementById('my-target').style.color = `var(--${g.target})`;
            document.getElementById('p1-name').innerText = g.role === 'host' ? me.nick : opp.nick;
            document.getElementById('p2-name').innerText = g.role === 'guest' ? me.nick : opp.nick;
            
            // 스코어 렌더링
            renderScores('p1-score-dots', g.role === 'host' ? g.scores.host : g.scores.guest);
            renderScores('p2-score-dots', g.role === 'guest' ? g.scores.host : g.scores.guest);
        }

        function renderScores(id, score) {
            const el = document.getElementById(id); el.innerHTML = '';
            for(let i=0; i<2; i++) {
                const dot = document.createElement('div');
                dot.className = 'score-dot' + (i < score ? ' win' : '');
                el.appendChild(dot);
            }
        }

        function renderBoard() {
            const b = document.getElementById('board'); b.innerHTML = '';
            g.board.forEach((c, i) => {
                const d = document.createElement('div');
                d.className = 'cell' + (g.lastIdx === i ? ' last-act' : '');
                if(c) {
                    const p = document.createElement('div');
                    p.className = `piece bg-${c.top} bd-${c.bottom}`;
                    d.appendChild(p);
                }
                d.onclick = () => handleMove(i);
                b.appendChild(d);
            });
            const myTurn = (g.turn % 2 === 1 && g.role === 'host') || (g.turn % 2 === 0 && g.role === 'guest');
            document.getElementById('turn-txt').innerText = `${myTurn ? '★ 당신의 차례' : '상대방 차례'} (제 ${g.turn}턴)`;
            document.getElementById('phase2-ui').style.display = g.turn >= 15 ? 'flex' : 'none';
        }

        function renderInv() {
            const ui = document.getElementById('inv-ui'); ui.innerHTML = '';
            g.inv.forEach((item, i) => {
                const div = document.createElement('div');
                div.className = `inv-item ${g.selIdx === i ? 'selected' : ''}`;
                const top = item.sides[item.top]; const bot = item.sides[1-item.top];
                div.innerHTML = `<div class="inv-preview bg-${top} bd-${bot}"></div><div style="font-size:10px;">${item.count}개</div>`;
                div.onclick = () => { g.selIdx = i; renderInv(); };
                ui.appendChild(div);
            });
        }

        window.handleMove = async (idx) => {
            const isMe = (g.turn % 2 === 1 && g.role === 'host') || (g.turn % 2 === 0 && g.role === 'guest');
            if(!isMe) return;
            if(idx === g.lastIdx && g.act !== 'place') return alert("상대가 방금 조작한 말입니다.");

            let ok = false;
            if(g.act === 'place' && !g.board[idx]) {
                const it = g.inv[g.selIdx]; if(it.count <= 0) return alert("말이 없습니다.");
                g.board[idx] = { top: it.sides[it.top], bottom: it.sides[1-it.top] };
                it.count--; ok = true;
            } else if(g.act === 'flip' && g.board[idx] && g.turn >= 15) {
                const p = g.board[idx]; g.board[idx] = { top: p.bottom, bottom: p.top }; ok = true;
            } else if(g.act === 'move' && g.board[idx] && g.turn >= 15) {
                // 이동 로직 (생략 - 이전과 동일)
            }

            if(ok) {
                const win = checkBingo(g.board);
                const ref = doc(db, "match_v1", g.room);
                const p = g.role === 'host' ? 'host' : 'guest';
                
                if(win) {
                    const newScore = g.scores[p] + 1;
                    alert(`라운드 승리! (컬러: ${win.toUpperCase()})`);
                    if(newScore >= 2) {
                        alert("최종 우승!"); location.reload();
                    } else {
                        // 라운드 리셋 로직
                        await updateDoc(ref, { 
                            board: Array(16).fill(null), turn: 1, lastIdx: -1,
                            [`${p}.score`]: newScore,
                            "host.inv": Array(3).fill(null).map((_,i)=>({sides:g.inv[i].sides, count:3, top:0})),
                            "guest.inv": Array(3).fill(null).map((_,i)=>({sides:g.inv[i].sides, count:3, top:0}))
                        });
                    }
                } else {
                    await updateDoc(ref, { board: g.board, turn: g.turn + 1, lastIdx: idx, [`${p}.inv`]: g.inv });
                }
            }
        };

        function checkBingo(board) {
            const lines = [[0,1,2,3],[4,5,6,7],[8,9,10,11],[12,13,14,15],[0,4,8,12],[1,5,9,13],[2,6,10,14],[3,7,11,15],[0,5,10,15],[3,6,9,12]];
            for(let l of lines) {
                const tops = l.map(i => board[i]?.top);
                if(tops.every(t => t && t === tops[0])) return tops[0];
            }
            return null;
        }

        window.flipSelected = () => { g.inv[g.selIdx].top = 1 - g.inv[g.selIdx].top; renderInv(); };
    </script>
</body>
</html>
