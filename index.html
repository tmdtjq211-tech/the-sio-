<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>UNIVERSITY WAR: BINGO PRO (OFFICIAL)</title>
    <style>
        :root { --bg: #0d0f1a; --panel: #1a1c2c; --red: #ff4d4d; --yellow: #ffd700; --blue: #4d79ff; }
        body { background: var(--bg); color: #fff; font-family: 'Pretendard', sans-serif; margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        .screen { display: none; width: 100%; max-width: 450px; padding: 20px; text-align: center; }
        .active { display: block; }

        /* 보드 및 말 디자인 (테두리에 뒷면 표시) */
        .board { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; background: #2a2d3e; padding: 10px; border-radius: 12px; margin: 20px 0; }
        .cell { aspect-ratio: 1/1; background: #1a1c2c; border: 1px solid #3f445e; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; position: relative; }
        .cell.last-act { outline: 3px solid #fff; outline-offset: -3px; }

        /* 말: 내부가 앞면, 테두리가 뒷면 */
        .piece { 
            width: 80%; height: 80%; border-radius: 6px; 
            box-sizing: border-box; border-width: 6px; border-style: solid;
            transition: all 0.3s;
        }
        .bg-red { background-color: var(--red); } .bd-red { border-color: var(--red); }
        .bg-yellow { background-color: var(--yellow); } .bd-yellow { border-color: var(--yellow); }
        .bg-blue { background-color: var(--blue); } .bd-blue { border-color: var(--blue); }

        /* 인벤토리 UI */
        .inventory { display: flex; justify-content: space-around; background: var(--panel); padding: 15px; border-radius: 12px; margin-top: 10px; border: 1px solid #333; }
        .inv-item { cursor: pointer; padding: 8px; border-radius: 8px; transition: 0.2s; text-align: center; }
        .inv-item.selected { background: #2d334d; box-shadow: 0 0 10px rgba(255,255,255,0.2); }
        .inv-preview { width: 40px; height: 40px; border-radius: 4px; border: 4px solid; margin: 0 auto 5px; }

        /* 하단 컨트롤 */
        button { background: #2d334d; color: white; border: 1px solid #444; padding: 12px; border-radius: 8px; cursor: pointer; width: 100%; margin: 5px 0; font-weight: bold; }
        button.primary { background: #4d79ff; border: none; }
        .btn-flip { background: #555; font-size: 0.8rem; margin-top: 5px; }
    </style>
</head>
<body>

    <div id="screen-lobby" class="screen active">
        <h1>UNIVERSITY WAR</h1>
        <p style="color: #888;">양면빙고 PRO: 9개 말 공식 룰</p>
        <input type="text" id="nick-in" placeholder="닉네임" style="width:100%; padding:12px; margin-bottom:10px; background:#111; border:1px solid #444; color:#fff; border-radius:8px;">
        <button class="primary" onclick="startTutorial()">튜토리얼 시작</button>
        <button onclick="startAIMode()">AI 연습 모드</button>
        <hr style="border: 0.5px solid #333; margin: 20px 0;">
        <input type="text" id="room-in" placeholder="방 코드" style="width:100%; padding:12px; margin-bottom:10px; background:#111; border:1px solid #444; color:#fff; border-radius:8px;">
        <button onclick="joinGame('player')">온라인 대전 입장</button>
    </div>

    <div id="screen-game" class="screen">
        <div id="status-bar" style="background:var(--panel); padding:15px; border-radius:12px; margin-bottom:15px;">
            <div id="turn-info" style="font-size: 1.1rem; color: #4d79ff; font-weight: bold;">당신의 차례 (1/30)</div>
            <div id="target-info" style="margin-top:5px; font-weight:bold;">목표: <span id="my-target">-</span></div>
        </div>

        <div class="board" id="board"></div>

        <div id="action-selector" style="display:none; margin-bottom:10px;">
            <div style="display:flex; gap:5px;">
                <button onclick="setAct('place')" id="act-p" style="background:#00c853;">착수</button>
                <button onclick="setAct('move')" id="act-m">이동</button>
                <button onclick="setAct('flip')" id="act-f">뒤집기</button>
            </div>
        </div>

        <div class="inventory" id="inventory"></div>
        <button class="btn-flip" onclick="flipSelected()">말 뒤집기 (앞면 색상 변경)</button>

        <button onclick="location.reload()" style="margin-top:20px; background:#444; font-size:0.8rem;">로비로 나가기</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase 설정 (사용자 설정 그대로 적용)
        const firebaseConfig = {
            apiKey: "AIzaSyDcKWKTei9L2Sat-XxinlXknabIcHgmjGs",
            authDomain: "d454545-ac9b1.firebaseapp.com",
            projectId: "d454545-ac9b1",
            storageBucket: "d454545-ac9b1.firebasestorage.app",
            messagingSenderId: "438189498590",
            appId: "1:438189498590:web:5c515415a9aa1f2b5aa24f"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // 게임 상태 관리
        let g = {
            nick: '', room: '', role: 'host', isAI: false,
            target: '', turn: 1, board: Array(16).fill(null), lastIdx: -1,
            // 3종류의 양면 말 세트 (빨-노, 노-파, 파-빨)
            inv: [
                { sides: ['red', 'yellow'], count: 3, topIdx: 0 },
                { sides: ['yellow', 'blue'], count: 3, topIdx: 0 },
                { sides: ['blue', 'red'], count: 3, topIdx: 0 }
            ],
            selIdx: 0, act: 'place', moveFrom: null
        };

        // --- 인벤토리 렌더링 ---
        function renderInv() {
            const invEl = document.getElementById('inventory');
            invEl.innerHTML = '';
            g.inv.forEach((item, i) => {
                const div = document.createElement('div');
                div.className = `inv-item ${g.selIdx === i ? 'selected' : ''}`;
                const top = item.sides[item.topIdx];
                const bottom = item.sides[1 - item.topIdx];
                
                div.innerHTML = `
                    <div class="inv-preview bg-${top} bd-${bottom}"></div>
                    <div style="font-size:10px;">${item.count}개</div>
                `;
                div.onclick = () => { g.selIdx = i; renderInv(); };
                invEl.appendChild(div);
            });
        }

        // 선택한 말 뒤집기 (착수 전 선택)
        window.flipSelected = () => {
            g.inv[g.selIdx].topIdx = 1 - g.inv[g.selIdx].topIdx;
            renderInv();
        };

        // --- 보드 렌더링 ---
        function renderBoard() {
            const b = document.getElementById('board');
            b.innerHTML = '';
            g.board.forEach((cell, i) => {
                const div = document.createElement('div');
                div.className = 'cell' + (g.lastIdx === i ? ' last-act' : '');
                if(cell) {
                    const p = document.createElement('div');
                    p.className = `piece bg-${cell.top} bd-${cell.bottom}`;
                    div.appendChild(p);
                }
                div.onclick = () => handleMove(i);
                b.appendChild(div);
            });
            
            document.getElementById('turn-info').innerText = `제 ${g.turn}턴 (${Math.ceil(g.turn/2)}회차)`;
            document.getElementById('action-selector').style.display = g.turn >= 15 ? 'block' : 'none';
        }

        // --- 착수 및 이동 로직 ---
        async function handleMove(idx) {
            const isMyTurn = (g.turn % 2 === 1 && g.role === 'host') || (g.turn % 2 === 0 && g.role === 'guest') || (g.isAI && g.turn % 2 === 1);
            if(!isMyTurn) return;
            if(idx === g.lastIdx && g.act !== 'place') return alert("상대가 방금 조작한 말은 건드릴 수 없습니다.");

            let updated = false;
            if(g.act === 'place' && !g.board[idx]) {
                const item = g.inv[g.selIdx];
                if(item.count <= 0) return alert("해당 종류의 말이 없습니다.");
                
                g.board[idx] = { top: item.sides[item.topIdx], bottom: item.sides[1 - item.topIdx] };
                item.count--;
                updated = true;
            } else if(g.act === 'flip' && g.board[idx]) {
                const p = g.board[idx];
                g.board[idx] = { top: p.bottom, bottom: p.top };
                updated = true;
            } else if(g.act === 'move') {
                if(g.moveFrom === null && g.board[idx]) { g.moveFrom = idx; alert("이동할 인접 칸을 선택하세요."); }
                else if(g.moveFrom !== null && !g.board[idx]) {
                    if([1, 4].includes(Math.abs(g.moveFrom - idx))) {
                        g.board[idx] = g.board[g.moveFrom];
                        g.board[g.moveFrom] = null;
                        updated = true; g.moveFrom = null;
                    } else { alert("인접한 칸으로만 이동 가능합니다."); g.moveFrom = null; }
                }
            }

            if(updated) {
                g.turn++; g.lastIdx = idx;
                if(g.isAI) { renderBoard(); renderInv(); if(!checkWin()) setTimeout(aiAction, 800); }
                else {
                    const ref = doc(db, "war_bingo_v2", g.room);
                    const invPath = g.role === 'host' ? "hostInv" : "guestInv";
                    await updateDoc(ref, { board: g.board, turn: g.turn, lastIdx: idx, [invPath]: g.inv });
                }
                checkWin();
            }
        }

        // --- 승리 판정 ---
        function checkWin() {
            const lines = [[0,1,2,3],[4,5,6,7],[8,9,10,11],[12,13,14,15],[0,4,8,12],[1,5,9,13],[2,6,10,14],[3,7,11,15],[0,5,10,15],[3,6,9,12]];
            for(let l of lines) {
                const tops = l.map(i => g.board[i]?.top);
                if(tops.every(t => t && t === tops[0])) {
                    alert(`게임 종료! 승리 컬러: ${tops[0].toUpperCase()}`);
                    location.reload(); return true;
                }
            }
            return false;
        }

        // AI 연습 모드 시작
        window.startAIMode = () => {
            g.isAI = true; g.target = 'RED'; g.role = 'host';
            document.getElementById('screen-lobby').classList.remove('active');
            document.getElementById('screen-game').classList.add('active');
            document.getElementById('my-target').innerText = g.target;
            renderBoard(); renderInv();
        };

        function aiAction() {
            const empties = g.board.map((v, i) => v === null ? i : null).filter(v => v !== null);
            if(empties.length > 0) {
                const idx = empties[Math.floor(Math.random() * empties.length)];
                g.board[idx] = { top: 'blue', bottom: 'yellow' }; // AI는 블루 고정 전략
                g.turn++; g.lastIdx = idx;
                renderBoard(); renderInv(); checkWin();
            }
        }

        window.joinGame = async (role) => {
            g.nick = document.getElementById('nick-in').value || 'Guest';
            g.room = document.getElementById('room-in').value.toUpperCase();
            if(!g.room) return alert("방 코드를 입력하세요.");
            g.role = role;
            
            const ref = doc(db, "war_bingo_v2", g.room);
            const snap = await getDoc(ref);
            if(!snap.exists()) {
                await setDoc(ref, { board: Array(16).fill(null), turn: 1, host: g.nick, hostInv: g.inv, lastIdx: -1, guest: null });
            } else if(role === 'player' && !snap.data().guest) {
                await updateDoc(ref, { guest: g.nick, guestInv: g.inv });
            }
            
            document.getElementById('screen-lobby').classList.remove('active');
            document.getElementById('screen-game').classList.add('active');
            onSnapshot(ref, (s) => {
                const data = s.data();
                g.board = data.board; g.turn = data.turn; g.lastIdx = data.lastIdx;
                const myInv = role === 'host' ? data.hostInv : data.guestInv;
                if(myInv) g.inv = myInv;
                renderBoard(); renderInv();
            });
        };
        
        window.setAct = (a) => { g.act = a; alert(`${a.toUpperCase()} 액션 선택됨`); };

    </script>
</body>
</html>
