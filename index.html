<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ëŒ€í•™ì „ìŸ: ì–‘ë©´ë¹™ê³  PRO</title>
    <style>
        :root { --bg: #0f111a; --panel: #1a1c2c; --p1: #ff4d4d; --p2: #ffd700; --p3: #4d79ff; }
        body { background: var(--bg); color: #fff; font-family: sans-serif; margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        .screen { display: none; width: 100%; max-width: 500px; padding: 20px; text-align: center; }
        .active { display: block; }

        /* ë³´ë“œíŒ */
        .board { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; background: #333; padding: 8px; border-radius: 8px; margin: 20px 0; }
        .cell { aspect-ratio: 1/1; background: #222; border: 2px solid #444; border-radius: 5px; position: relative; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .cell.last-target { border: 2px solid #ffffff; box-shadow: 0 0 10px #fff; }

        /* ë§ ë””ìì¸ */
        .piece { width: 80%; height: 80%; border-radius: 50%; border: 4px solid rgba(0,0,0,0.2); transition: 0.3s; position: relative; }
        .piece::after { content: ''; position: absolute; top: 15%; left: 15%; width: 30%; height: 30%; background: rgba(255,255,255,0.2); border-radius: 50%; }
        .color-red { background: var(--p1); }
        .color-yellow { background: var(--p2); }
        .color-blue { background: var(--p3); }

        /* ì¸ë²¤í† ë¦¬ */
        .inventory { display: flex; justify-content: center; gap: 10px; background: var(--panel); padding: 10px; border-radius: 10px; margin-top: 10px; }
        .inv-item { border: 2px solid transparent; padding: 5px; cursor: pointer; }
        .inv-item.selected { border-color: #fff; background: #333; border-radius: 5px; }
        .count-tag { font-size: 10px; color: #aaa; }

        /* ë²„íŠ¼ ë° ê¸°íƒ€ */
        button { background: #333; color: white; border: 1px solid #555; padding: 10px; border-radius: 5px; cursor: pointer; margin: 5px; }
        .action-btn { background: #444; width: 30%; font-size: 12px; }
        .action-btn.active { background: #00c853; }
        .secret-box { background: #111; border: 1px dashed #666; padding: 10px; margin: 10px 0; }
    </style>
</head>
<body>

    <div id="screen-login" class="screen active">
        <h1>UNIVERSITY WAR</h1>
        <h3>ì–‘ë©´ë¹™ê³  PRO (Official Rule)</h3>
        <input type="text" id="in-nick" placeholder="ë‹‰ë„¤ì„" style="padding:10px; width:80%; margin-bottom:10px;">
        <input type="text" id="in-room" placeholder="ë°© ì½”ë“œ (ì˜ˆ: ABCDE)" style="padding:10px; width:80%;">
        <div style="margin-top:20px;">
            <button onclick="joinGame('player')">í”Œë ˆì´ì–´ë¡œ ì…ì¥</button>
            <button onclick="joinGame('spectator')">ê´€ì „ìë¡œ ì…ì¥</button>
        </div>
    </div>

    <div id="screen-game" class="screen">
        <div id="status-panel" style="font-size: 14px; background: var(--panel); padding: 10px; border-radius: 10px;">
            <div id="turn-display">ëŒ€ê¸° ì¤‘...</div>
            <div id="secret-color" class="secret-box">ë‚˜ì˜ ëª©í‘œ: ??? (ê²Œì„ ì‹œì‘ ì‹œ ê³µê°œ)</div>
        </div>

        <div class="board" id="board"></div>

        <div id="action-selector" style="display:none; margin-bottom: 10px;">
            <button class="action-btn active" id="act-place" onclick="setAction('place')">ì°©ìˆ˜</button>
            <button class="action-btn" id="act-move" onclick="setAction('move')">ì´ë™</button>
            <button class="action-btn" id="act-flip" onclick="setAction('flip')">ë’¤ì§‘ê¸°</button>
        </div>

        <div id="inventory-ui" class="inventory">
            </div>

        <div id="control-panel" style="margin-top:20px;">
            <button id="btn-ready" onclick="toggleReady()">ì¤€ë¹„í•˜ê¸°</button>
            <button onclick="location.reload()">ë°© ë‚˜ê°€ê¸°</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase ì„¤ì • (ê¸°ì¡´ ì„¤ì • ê·¸ëŒ€ë¡œ ì‚¬ìš©)
        const firebaseConfig = {
            apiKey: "AIzaSyDcKWKTei9L2Sat-XxinlXknabIcHgmjGs",
            authDomain: "d454545-ac9b1.firebaseapp.com",
            projectId: "d454545-ac9b1",
            storageBucket: "d454545-ac9b1.firebasestorage.app",
            messagingSenderId: "438189498590",
            appId: "1:438189498590:web:5c515415a9aa1f2b5aa24f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let my = { nick: '', room: '', role: '', secret: '', selectedInv: 0, action: 'place', lastClickIdx: null };
        let game = { board: [], turn: 0, host: null, guest: null, lastIdx: -1 };

        window.joinGame = async (role) => {
            my.nick = document.getElementById('in-nick').value || 'Guest';
            my.room = document.getElementById('in-room').value.toUpperCase();
            my.role = role;
            if(!my.room) return alert("ë°© ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

            const roomRef = doc(db, "rooms_pro", my.room);
            const snap = await getDoc(roomRef);

            if(!snap.exists()) {
                await setDoc(roomRef, {
                    board: Array(16).fill(null), turn: 1, status: 'waiting',
                    host: { nick: my.nick, ready: false, inv: [3,3,3], secret: 'red' },
                    guest: null, lastIdx: -1
                });
            } else if(role === 'player' && !snap.data().guest) {
                await updateDoc(roomRef, { guest: { nick: my.nick, ready: false, inv: [3,3,3], secret: 'blue' }});
            }

            document.getElementById('screen-login').classList.remove('active');
            document.getElementById('screen-game').classList.add('active');
            initListener();
        };

        function initListener() {
            onSnapshot(doc(db, "rooms_pro", my.room), (snap) => {
                game = snap.data();
                renderGame();
            });
        }

        function renderGame() {
            // ë³´ë“œ ë Œë”ë§
            const boardEl = document.getElementById('board');
            boardEl.innerHTML = '';
            game.board.forEach((cell, i) => {
                const div = document.createElement('div');
                div.className = 'cell' + (game.lastIdx === i ? ' last-target' : '');
                if(cell) {
                    const p = document.createElement('div');
                    p.className = `piece color-${cell.top}`;
                    div.appendChild(p);
                }
                div.onclick = () => handleCellClick(i);
                boardEl.appendChild(div);
            });

            // ìƒíƒœ ì—…ë°ì´íŠ¸
            const isMyTurn = (game.turn % 2 === 1 && my.role === 'host') || (game.turn % 2 === 0 && my.role === 'guest');
            document.getElementById('turn-display').innerText = isMyTurn ? "ğŸ”´ ë‹¹ì‹ ì˜ ì°¨ë¡€" : "â³ ìƒëŒ€ë°© ì°¨ë¡€";
            
            // ë¹„ë°€ ì»¬ëŸ¬ í‘œì‹œ
            const myData = my.role === 'host' ? game.host : game.guest;
            if(myData) {
                document.getElementById('secret-color').innerText = `ë‚˜ì˜ ëª©í‘œ: ${myData.secret.toUpperCase()}`;
                document.getElementById('secret-color').style.color = myData.secret;
            }

            // ì•¡ì…˜ ì„ íƒê¸° (8í„´ ì´í›„ í•´ê¸ˆ - ì´ 15í„´ë¶€í„°)
            document.getElementById('action-selector').style.display = game.turn >= 15 ? 'flex' : 'none';

            // ì¸ë²¤í† ë¦¬ ë Œë”ë§
            renderInventory(myData?.inv || [0,0,0]);
        }

        function renderInventory(inv) {
            const invEl = document.getElementById('inventory-ui');
            invEl.innerHTML = '';
            const types = [['red','yellow'], ['yellow','blue'], ['blue','red']];
            types.forEach((colors, i) => {
                const item = document.createElement('div');
                item.className = `inv-item ${my.selectedInv === i ? 'selected' : ''}`;
                item.innerHTML = `<div class="piece color-${colors[0]}" style="width:30px; height:30px;"></div><div class="count-tag">${inv[i]}ê°œ</div>`;
                item.onclick = () => { my.selectedInv = i; renderGame(); };
                invEl.appendChild(item);
            });
        }

        window.setAction = (a) => { my.action = a; renderGame(); };

        window.handleCellClick = async (idx) => {
            if(!isMyTurn()) return;
            if(idx === game.lastIdx && my.action !== 'place') return alert("ìƒëŒ€ê°€ ë°©ê¸ˆ ê±´ë“œë¦° ë§ì€ ì¡°ì‘ ë¶ˆê°€!");

            const roomRef = doc(db, "rooms_pro", my.room);
            let newBoard = [...game.board];

            if(my.action === 'place') {
                if(newBoard[idx]) return;
                const myData = my.role === 'host' ? game.host : game.guest;
                if(myData.inv[my.selectedInv] <= 0) return alert("ë‚¨ì€ ë§ì´ ì—†ìŠµë‹ˆë‹¤!");
                
                const types = [['red','yellow'], ['yellow','blue'], ['blue','red']];
                newBoard[idx] = { top: types[my.selectedInv][0], bottom: types[my.selectedInv][1] };
                
                const newInv = [...myData.inv];
                newInv[my.selectedInv]--;
                const updatePath = my.role === 'host' ? { "host.inv": newInv } : { "guest.inv": newInv };
                await updateDoc(roomRef, { ...updatePath, board: newBoard, turn: game.turn + 1, lastIdx: idx });
            } 
            else if(my.action === 'flip') {
                if(!newBoard[idx]) return;
                const p = newBoard[idx];
                newBoard[idx] = { top: p.bottom, bottom: p.top };
                await updateDoc(roomRef, { board: newBoard, turn: game.turn + 1, lastIdx: idx });
            }
            else if(my.action === 'move') {
                if(my.lastClickIdx === null) {
                    if(!newBoard[idx]) return;
                    my.lastClickIdx = idx;
                    alert("ì´ë™í•  ì¹¸ì„ ì„ íƒí•˜ì„¸ìš”.");
                } else {
                    if(newBoard[idx]) return (my.lastClickIdx = null);
                    // ì¸ì ‘ ì²´í¬ (ê°„ë‹¨í™”)
                    const diff = Math.abs(my.lastClickIdx - idx);
                    if(diff === 1 || diff === 4) {
                        newBoard[idx] = newBoard[my.lastClickIdx];
                        newBoard[my.lastClickIdx] = null;
                        await updateDoc(roomRef, { board: newBoard, turn: game.turn + 1, lastIdx: idx });
                    }
                    my.lastClickIdx = null;
                }
            }
        };

        function isMyTurn() {
            return (game.turn % 2 === 1 && my.role === 'host') || (game.turn % 2 === 0 && my.role === 'guest');
        }

        window.toggleReady = async () => {
            const roomRef = doc(db, "rooms_pro", my.room);
            const path = my.role === 'host' ? "host.ready" : "guest.ready";
            await updateDoc(roomRef, { [path]: true });
        };
    </script>
</body>
</html>
