<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UNIVERSITY WAR: BINGO PRO</title>
    <style>
        :root { --bg: #0a0c14; --panel: #161b2a; --p1: #ff4d4d; --p2: #ffcc00; --p3: #3399ff; }
        body { background: var(--bg); color: #eee; font-family: 'Pretendard', sans-serif; margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; overflow-x: hidden; }
        
        .screen { display: none; width: 100%; max-width: 450px; padding: 20px; box-sizing: border-box; text-align: center; }
        .active { display: block; }

        /* 보드 및 말 디자인 */
        .board { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; background: #222; padding: 10px; border-radius: 8px; margin: 15px 0; }
        .cell { aspect-ratio: 1/1; background: #111; border: 2px solid #333; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; position: relative; }
        .cell.last-target { border: 2px solid #fff; box-shadow: 0 0 8px #fff; }
        
        .piece { width: 85%; height: 85%; border-radius: 4px; transition: transform 0.4s; position: relative; }
        .c-red { background: var(--p1); } .c-yellow { background: var(--p2); } .c-blue { background: var(--p3); }

        /* 인벤토리 UI */
        .inventory { display: flex; justify-content: space-around; background: var(--panel); padding: 10px; border-radius: 8px; margin-top: 10px; }
        .inv-item { border: 2px solid transparent; padding: 5px; cursor: pointer; text-align: center; }
        .inv-item.selected { border-color: #fff; background: #252d44; border-radius: 6px; }
        .inv-box { width: 30px; height: 30px; border-radius: 3px; margin: 0 auto 5px; }

        /* 튜토리얼 오버레이 */
        #tutorial-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; z-index: 100; justify-content: center; align-items: center; }
        .tut-box { background: var(--panel); padding: 25px; border-radius: 15px; width: 80%; max-width: 350px; border: 1px solid #444; }

        button { background: #252d44; color: #fff; border: 1px solid #444; padding: 12px; border-radius: 6px; cursor: pointer; width: 100%; margin: 5px 0; font-weight: bold; }
        button.primary { background: #3399ff; border: none; }
        .active-btn { background: #00c853 !important; }
        .action-group { display: flex; gap: 5px; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div id="screen-lobby" class="screen active">
        <h1 style="letter-spacing: 4px;">UNIVERSITY WAR</h1>
        <p style="color: #888; font-size: 0.9rem;">양면빙고 오피셜 룰 통합 버전</p>
        <input type="text" id="nick-in" placeholder="닉네임 입력" style="width:100%; padding:12px; margin-bottom:10px; box-sizing:border-box; background:#111; border:1px solid #444; color:#fff;">
        <button class="primary" onclick="startTutorial()">신규 유저 튜토리얼</button>
        <button onclick="startAIMode()">AI 연습 모드 (싱글)</button>
        <hr style="border: 0.5px solid #333; margin: 20px 0;">
        <input type="text" id="room-in" placeholder="방 코드 (예: SEOUL)" style="width:100%; padding:12px; margin-bottom:10px; box-sizing:border-box; background:#111; border:1px solid #444; color:#fff;">
        <button onclick="joinOnline('player')">플레이어로 입장</button>
        <button onclick="joinOnline('spectator')">관전자로 입장</button>
    </div>

    <div id="screen-game" class="screen">
        <div id="info-bar" style="background:var(--panel); padding:15px; border-radius:10px; margin-bottom:15px;">
            <div id="turn-txt" style="font-size: 1.1rem; font-weight:bold; color:var(--p3);">당신의 차례 (1/30)</div>
            <div id="target-txt" style="margin-top:5px; font-weight:bold;">목표 색상: <span id="my-color">-</span></div>
        </div>

        <div class="board" id="board"></div>

        <div id="action-ui" style="display:none;">
            <div class="action-group">
                <button id="btn-place" class="active-btn" onclick="setAct('place')">착수</button>
                <button id="btn-move" onclick="setAct('move')">이동</button>
                <button id="btn-flip" onclick="setAct('flip')">뒤집기</button>
            </div>
        </div>

        <div class="inventory" id="inv-ui"></div>

        <button onclick="location.reload()" style="margin-top:20px; background:#444;">방 나가기</button>
    </div>

    <div id="tutorial-overlay">
        <div class="tut-box">
            <h3 id="tut-title">게임 규칙</h3>
            <p id="tut-desc" style="line-height:1.6; color:#ccc;"></p>
            <button class="primary" onclick="nextTut()">다음</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDcKWKTei9L2Sat-XxinlXknabIcHgmjGs",
            authDomain: "d454545-ac9b1.firebaseapp.com",
            projectId: "d454545-ac9b1",
            storageBucket: "d454545-ac9b1.firebasestorage.app",
            messagingSenderId: "438189498590",
            appId: "1:438189498590:web:5c515415a9aa1f2b5aa24f"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let g = { 
            state: 'lobby', isAI: false, role: 'host', 
            nick: '', room: '', target: '', 
            turn: 1, board: Array(16).fill(null), 
            inv: [3, 3, 3], selInv: 0, act: 'place', lastIdx: -1, moveStart: null
        };

        const PIECE_TYPES = [['red','yellow'], ['yellow','blue'], ['blue','red']];

        // --- 튜토리얼 시스템 ---
        const tutSteps = [
            { t: "말의 종류", d: "빨-노, 노-파, 파-빨 양면으로 된 3종류의 말이 각 3개씩(총 9개) 주어집니다." },
            { t: "목표 색상", d: "비밀리에 지정된 본인의 목표 색상으로 빙고를 먼저 만들면 승리합니다." },
            { t: "Phase 1 (1~14턴)", d: "처음 7번의 턴 동안은 오직 말을 '착수'만 할 수 있습니다." },
            { t: "Phase 2 (15턴~)", d: "8번째 턴부터는 착수 대신 이미 놓인 말을 '이동'하거나 '뒤집기' 할 수 있습니다." },
            { t: "방어 규칙", d: "상대가 직전에 조작한 말은 다음 턴에 즉시 이동하거나 뒤집을 수 없습니다." }
        ];
        let tutIdx = 0;

        window.startTutorial = () => {
            document.getElementById('tutorial-overlay').style.display = 'flex';
            tutIdx = 0; showTut();
        };
        window.nextTut = () => {
            tutIdx++;
            if(tutIdx < tutSteps.length) showTut();
            else document.getElementById('tutorial-overlay').style.display = 'none';
        };
        function showTut() {
            document.getElementById('tut-title').innerText = tutSteps[tutIdx].t;
            document.getElementById('tut-desc').innerText = tutSteps[tutIdx].d;
        }

        // --- AI 모드 및 로직 ---
        window.startAIMode = () => {
            g.nick = document.getElementById('nick-in').value || '플레이어';
            g.isAI = true; g.target = 'red'; g.state = 'playing';
            document.getElementById('screen-lobby').classList.remove('active');
            document.getElementById('screen-game').classList.add('active');
            render();
        };

        function aiTurn() {
            setTimeout(() => {
                let moved = false;
                const empties = g.board.map((v, i) => v === null ? i : null).filter(v => v !== null);
                
                // 간단 AI: 빈 칸에 랜덤 착수
                if(empties.length > 0) {
                    const idx = empties[Math.floor(Math.random() * empties.length)];
                    g.board[idx] = { top: 'blue', bottom: 'yellow' };
                    g.turn++; g.lastIdx = idx;
                    render();
                    checkWin();
                }
            }, 1000);
        }

        // --- 온라인 매칭 ---
        window.joinOnline = async (role) => {
            g.nick = document.getElementById('nick-in').value || 'Guest';
            g.room = document.getElementById('room-in').value.toUpperCase();
            if(!g.room) return alert("방 코드를 입력하세요.");
            g.role = role;

            const ref = doc(db, "war_bingo", g.room);
            const snap = await getDoc(ref);
            if(!snap.exists()) {
                await setDoc(ref, { board: Array(16).fill(null), turn: 1, host: { nick: g.nick, inv: [3,3,3], target: 'red' }, guest: null, lastIdx: -1 });
            } else if(role === 'player' && !snap.data().guest) {
                await updateDoc(ref, { guest: { nick: g.nick, inv: [3,3,3], target: 'blue' }});
            }
            
            document.getElementById('screen-lobby').classList.remove('active');
            document.getElementById('screen-game').classList.add('active');
            onSnapshot(ref, (s) => { 
                const data = s.data();
                g.board = data.board; g.turn = data.turn; g.lastIdx = data.lastIdx;
                const me = role === 'host' ? data.host : data.guest;
                if(me) { g.target = me.target; g.inv = me.inv; }
                render();
            });
        };

        // --- 게임 렌더링 및 조작 ---
        function render() {
            const b = document.getElementById('board'); b.innerHTML = '';
            g.board.forEach((c, i) => {
                const d = document.createElement('div');
                d.className = 'cell' + (g.lastIdx === i ? ' last-target' : '');
                if(c) {
                    const p = document.createElement('div');
                    p.className = `piece c-${c.top}`;
                    d.appendChild(p);
                }
                d.onclick = () => handleCell(i);
                b.appendChild(d);
            });

            document.getElementById('my-color').innerText = g.target.toUpperCase();
            document.getElementById('my-color').style.color = `var(--p${g.target === 'red'?1:g.target==='yellow'?2:3})`;
            document.getElementById('turn-txt').innerText = `제 ${g.turn}턴 (${Math.ceil(g.turn/2)}/15회차)`;
            document.getElementById('action-ui').style.display = g.turn >= 15 ? 'block' : 'none';
            
            renderInv();
        }

        function renderInv() {
            const ui = document.getElementById('inv-ui'); ui.innerHTML = '';
            PIECE_TYPES.forEach((t, i) => {
                const item = document.createElement('div');
                item.className = `inv-item ${g.selInv === i ? 'selected' : ''}`;
                item.innerHTML = `<div class="inv-box c-${t[0]}" style="border-bottom: 4px solid var(--p${t[1]==='red'?1:t[1]==='yellow'?2:3})"></div><span style="font-size:10px;">${g.inv[i]}개</span>`;
                item.onclick = () => { g.selInv = i; render(); };
                ui.appendChild(item);
            });
        }

        window.setAct = (a) => { g.act = a; render(); };

        window.handleCell = async (idx) => {
            const isMyTurn = g.isAI ? (g.turn % 2 === 1) : ( (g.turn % 2 === 1 && g.role === 'host') || (g.turn % 2 === 0 && g.role === 'guest') );
            if(!isMyTurn) return;
            if(idx === g.lastIdx && g.act !== 'place') return alert("상대가 방금 건드린 말입니다!");

            let updated = false;
            if(g.act === 'place' && !g.board[idx]) {
                if(g.inv[g.selInv] <= 0) return alert("남은 말이 없습니다.");
                g.board[idx] = { top: PIECE_TYPES[g.selInv][0], bottom: PIECE_TYPES[g.selInv][1] };
                g.inv[g.selInv]--; updated = true;
            } else if(g.act === 'flip' && g.board[idx]) {
                const p = g.board[idx]; g.board[idx] = { top: p.bottom, bottom: p.top };
                updated = true;
            } else if(g.act === 'move') {
                if(g.moveStart === null && g.board[idx]) { g.moveStart = idx; alert("이동할 인접 칸을 선택하세요."); }
                else if(g.moveStart !== null && !g.board[idx]) {
                    const diff = Math.abs(g.moveStart - idx);
                    if(diff === 1 || diff === 4) {
                        g.board[idx] = g.board[g.moveStart]; g.board[g.moveStart] = null;
                        updated = true; g.moveStart = null;
                    } else { g.moveStart = null; alert("인접한 칸으로만 이동 가능합니다."); }
                }
            }

            if(updated) {
                g.turn++; g.lastIdx = idx;
                if(g.isAI) { render(); if(!checkWin()) aiTurn(); }
                else {
                    const ref = doc(db, "war_bingo", g.room);
                    const invPath = g.role === 'host' ? "host.inv" : "guest.inv";
                    await updateDoc(ref, { board: g.board, turn: g.turn, lastIdx: idx, [invPath]: g.inv });
                }
                checkWin();
            }
        };

        function checkWin() {
            const lines = [[0,1,2,3],[4,5,6,7],[8,9,10,11],[12,13,14,15],[0,4,8,12],[1,5,9,13],[2,6,10,14],[3,7,11,15],[0,5,10,15],[3,6,9,12]];
            for(let l of lines) {
                const colors = l.map(i => g.board[i]?.top);
                if(colors.every(c => c && c === colors[0])) {
                    alert(`빙고 완성! 승리 컬러: ${colors[0].toUpperCase()}`);
                    location.reload(); return true;
                }
            }
            return false;
        }
    </script>
</body>
</html>
